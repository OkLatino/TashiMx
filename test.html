<!DOCTYPE html>
<html lang="es">

<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-FWM2VNVTR0"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag() { dataLayer.push(arguments); }
        gtag('js', new Date());

        gtag('config', 'G-FWM2VNVTR0');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Diagn√≥stico - Mavi Bayona</title>

    <!-- Favicon -->
    <link rel="icon" type="image/png" href="../assets/logoMavi.png">
    <link rel="shortcut icon" type="image/png" href="../assets/logoMavi.png">
    <link rel="apple-touch-icon" href="../assets/logoMavi.png">

    <!-- Chart.js para gr√°ficos -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>

    <!-- jsPDF para generar PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-gold: #D4AF37;
            --primary-cyan: #1B9AAA;
            --primary-turquoise: #06D6A0;
            --accent-teal: #2D9596;
            --neutral-light: #F8F9FA;
            --neutral-dark: #2C3E50;
            --text-dark: #333333;
            --text-light: #666666;
            --white: #FFFFFF;
            --gradient-primary: linear-gradient(135deg, #1B9AAA 0%, #06D6A0 50%, #2D9596 100%);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: var(--text-dark);
            background: var(--neutral-light);
            padding: 2rem 1rem;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Header */
        .test-header {
            text-align: center;
            margin-bottom: 3rem;
            padding: 2rem;
            background: white;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }

        .logo {
            width: 60px;
            height: auto;
            margin-bottom: 1rem;
        }

        .test-header h1 {
            color: var(--primary-cyan);
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        .test-header p {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .progress-bar {
            background: #e0e0e0;
            height: 8px;
            border-radius: 10px;
            margin: 2rem 0;
            overflow: hidden;
        }

        .progress-fill {
            background: var(--gradient-primary);
            height: 100%;
            width: 0%;
            transition: width 0.3s ease;
            border-radius: 10px;
        }

        .progress-text {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 1rem;
            font-weight: 600;
        }

        /* Questions */
        .question-container {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
            display: none;
        }

        .question-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .question-number {
            color: var(--primary-cyan);
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .question-text {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-dark);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .options {
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }

        .option {
            background: var(--neutral-light);
            padding: 1.2rem 1.5rem;
            border-radius: 12px;
            border: 2px solid transparent;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .option:hover {
            background: #e8f4f5;
            border-color: var(--primary-cyan);
            transform: translateX(5px);
        }

        .option.selected {
            background: var(--primary-cyan);
            color: white;
            border-color: var(--primary-cyan);
        }

        .option-radio {
            width: 24px;
            height: 24px;
            border: 2px solid var(--primary-cyan);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .option.selected .option-radio {
            border-color: white;
        }

        .option-radio::after {
            content: '';
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--primary-cyan);
            display: none;
        }

        .option.selected .option-radio::after {
            display: block;
            background: white;
        }

        .option-text {
            flex: 1;
            font-size: 1.05rem;
        }

        /* Navigation Buttons */
        .navigation {
            display: flex;
            justify-content: space-between;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 50px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-secondary {
            background: var(--neutral-light);
            color: var(--text-dark);
        }

        .btn-secondary:hover {
            background: #e0e0e0;
        }

        .btn-primary {
            background: var(--primary-cyan);
            color: white;
            flex: 1;
        }

        .btn-primary:hover {
            background: var(--accent-teal);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(27, 154, 170, 0.3);
        }

        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Results Section */
        .results-container {
            background: white;
            padding: 3rem;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.1);
            display: none;
        }

        .results-container.active {
            display: block;
            animation: fadeIn 0.5s ease;
        }

        .results-header {
            text-align: center;
            margin-bottom: 3rem;
        }

        .results-icon {
            width: 100px;
            height: 100px;
            margin: 0 auto 1.5rem;
        }

        .results-header h2 {
            color: var(--primary-cyan);
            font-size: 2.2rem;
            margin-bottom: 1rem;
        }

        .results-header .subtitle {
            color: var(--text-light);
            font-size: 1.1rem;
        }

        .diagnosis-card {
            background: var(--gradient-primary);
            color: white;
            padding: 2.5rem;
            border-radius: 20px;
            margin-bottom: 2rem;
            box-shadow: 0 6px 20px rgba(27, 154, 170, 0.3);
        }

        .diagnosis-title {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 1rem;
        }

        .diagnosis-description {
            font-size: 1.1rem;
            line-height: 1.8;
            opacity: 0.95;
        }

        .scores-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .score-card {
            background: var(--neutral-light);
            padding: 1.5rem;
            border-radius: 15px;
            border-left: 4px solid var(--primary-cyan);
        }

        .score-label {
            color: var(--text-light);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            font-weight: 600;
        }

        .score-bar {
            background: #e0e0e0;
            height: 12px;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 0.5rem;
        }

        .score-bar-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 1s ease;
        }

        .score-bar-fill.ansiedad {
            background: linear-gradient(90deg, #FF6B6B, #FF8E53);
        }

        .score-bar-fill.depresion {
            background: linear-gradient(90deg, #4A5568, #667EEA);
        }

        .score-bar-fill.estres {
            background: linear-gradient(90deg, #F6AD55, #FC8181);
        }

        .score-bar-fill.duelo {
            background: linear-gradient(90deg, #718096, #4299E1);
        }

        .score-bar-fill.vacio {
            background: linear-gradient(90deg, #9F7AEA, #667EEA);
        }

        .score-percentage {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--primary-cyan);
        }

        .recommendations {
            background: #FFF9E6;
            border-left: 4px solid var(--primary-gold);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .recommendations h3 {
            color: var(--accent-teal);
            margin-bottom: 1rem;
            font-size: 1.3rem;
        }

        .recommendations ul {
            list-style: none;
            padding: 0;
        }

        .recommendations li {
            padding: 0.5rem 0;
            padding-left: 1.5rem;
            position: relative;
        }

        .recommendations li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: var(--primary-gold);
            font-weight: bold;
        }

        /* Email Form */
        .email-form {
            background: var(--neutral-light);
            padding: 2rem;
            border-radius: 15px;
            margin-bottom: 2rem;
        }

        .email-form h3 {
            color: var(--primary-cyan);
            margin-bottom: 1rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--text-dark);
        }

        .form-group input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus {
            outline: none;
            border-color: var(--primary-cyan);
        }

        .btn-submit {
            background: var(--primary-gold);
            color: var(--text-dark);
            width: 100%;
            padding: 1.2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-submit:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .cta-section {
            text-align: center;
            padding: 2rem;
            background: var(--gradient-primary);
            color: white;
            border-radius: 15px;
        }

        .cta-section h3 {
            font-size: 1.8rem;
            margin-bottom: 1rem;
        }

        .cta-section p {
            margin-bottom: 1.5rem;
            opacity: 0.95;
        }

        .btn-cta {
            background: white;
            color: var(--primary-cyan);
            padding: 1.2rem 2.5rem;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 700;
            display: inline-block;
            transition: all 0.3s ease;
        }

        .btn-cta:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.2);
        }

        /* Charts Section */
        .charts-section {
            background: white;
            padding: 2.5rem;
            border-radius: 20px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 2rem;
        }

        .charts-section h3 {
            color: var(--primary-cyan);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 1.8rem;
        }

        .charts-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 3rem;
            align-items: center;
        }

        .chart-wrapper {
            position: relative;
            max-width: 400px;
            margin: 0 auto;
        }

        .chart-legend {
            margin-top: 2rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.8rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            background: var(--neutral-light);
        }

        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            margin-right: 0.8rem;
        }

        .legend-label {
            display: flex;
            align-items: center;
            flex: 1;
            font-weight: 600;
        }

        .legend-value {
            font-weight: 700;
            font-size: 1.1rem;
            color: var(--primary-cyan);
        }

        /* PDF Download Button */
        .btn-download {
            background: var(--primary-gold);
            color: var(--text-dark);
            padding: 1.2rem 2.5rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.8rem;
            margin-bottom: 2rem;
        }

        .btn-download:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(212, 175, 55, 0.4);
        }

        .download-section {
            text-align: center;
            margin-bottom: 2rem;
        }

        /* Success Message */
        .success-message {
            background: #48BB78;
            color: white;
            padding: 1.5rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: none;
            align-items: center;
            gap: 1rem;
        }

        .success-message.show {
            display: flex;
            animation: fadeIn 0.5s ease;
        }

        /* Lead Magnet Modal */
        .lead-magnet-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            z-index: 9999;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            animation: fadeIn 0.3s ease;
        }

        .lead-magnet-overlay.show {
            display: flex;
        }

        .lead-magnet-modal {
            background: white;
            border-radius: 20px;
            padding: 3rem;
            max-width: 600px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.4s ease;
            position: relative;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .lead-magnet-modal h3 {
            color: var(--primary-cyan);
            font-size: 2rem;
            margin-bottom: 1rem;
            text-align: center;
        }

        .lead-magnet-modal p {
            color: var(--text-light);
            font-size: 1.1rem;
            text-align: center;
            margin-bottom: 2rem;
            line-height: 1.6;
        }

        .lead-magnet-form .form-group {
            margin-bottom: 1.5rem;
        }

        .lead-magnet-form label {
            display: block;
            color: var(--text-dark);
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .lead-magnet-form input {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .lead-magnet-form input:focus {
            outline: none;
            border-color: var(--primary-cyan);
            box-shadow: 0 0 0 3px rgba(27, 154, 170, 0.1);
        }

        .lead-magnet-form button {
            width: 100%;
            background: var(--primary-cyan);
            color: white;
            padding: 1.2rem;
            border: none;
            border-radius: 50px;
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 1rem;
        }

        .lead-magnet-form button:hover {
            background: var(--accent-teal);
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(27, 154, 170, 0.3);
        }

        .skip-button {
            display: block;
            text-align: center;
            color: var(--text-light);
            text-decoration: none;
            font-size: 0.9rem;
            transition: color 0.3s ease;
            cursor: pointer;
        }

        .skip-button:hover {
            color: var(--primary-cyan);
        }

        /* Responsive */
        @media (max-width: 768px) {
            body {
                padding: 1rem 0.5rem;
            }

            .test-header {
                padding: 1.5rem;
            }

            .test-header h1 {
                font-size: 1.5rem;
            }

            .question-container {
                padding: 1.5rem;
            }

            .question-text {
                font-size: 1.1rem;
            }

            .results-container {
                padding: 2rem 1.5rem;
            }

            .results-header h2 {
                font-size: 1.8rem;
            }

            .diagnosis-title {
                font-size: 1.5rem;
            }

            .scores-grid {
                grid-template-columns: 1fr;
            }

            .navigation {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .charts-container {
                grid-template-columns: 1fr;
                gap: 2rem;
            }

            .charts-section {
                padding: 1.5rem;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- Header -->
        <div class="test-header">
            <div
                style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                <img src="../assets/logoMavi.png" alt="Mavi Bayona" class="logo"
                    style="width: 60px; height: auto; display: block;">
                <img src="../assets/mavibayona-logo.png" alt="Mavi Bayona"
                    style="width: 180px; max-width: 90%; height: auto; display: block; opacity: 0.9;">
            </div>
            <h1>Test de Diagn√≥stico Emocional</h1>
            <p>Responde con sinceridad. Este es un espacio para ti, sin juicios.</p>
        </div>

        <!-- Progress Bar -->
        <div class="progress-text">
            Pregunta <span id="currentQuestion">1</span> de <span id="totalQuestions">15</span>
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>

        <!-- Questions Container -->
        <div id="questionsContainer"></div>

        <!-- Results Container -->
        <div class="results-container" id="resultsContainer">
            <div class="results-header">
                <svg class="results-icon" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <circle cx="12" cy="12" r="10" stroke="#1B9AAA" stroke-width="2" fill="none" />
                    <path d="M8 12L11 15L16 9" stroke="#06D6A0" stroke-width="2.5" stroke-linecap="round"
                        stroke-linejoin="round" />
                </svg>
                <h2>Resultados de tu Test</h2>
                <p class="subtitle">An√°lisis basado en tus respuestas</p>
            </div>

            <div class="diagnosis-card" id="mainDiagnosis">
                <!-- Se llenar√° din√°micamente -->
            </div>

            <!-- Secci√≥n de Gr√°ficos Circulares -->
            <div class="charts-section">
                <h3>üìä Visualizaci√≥n de Resultados</h3>
                <div class="charts-container">
                    <div class="chart-wrapper">
                        <canvas id="resultsChart"></canvas>
                    </div>
                    <div class="chart-legend" id="chartLegend">
                        <!-- Se llenar√° din√°micamente -->
                    </div>
                </div>
            </div>

            <div class="scores-grid" id="scoresGrid">
                <!-- Se llenar√° din√°micamente -->
            </div>

            <div class="recommendations" id="recommendations">
                <!-- Se llenar√° din√°micamente -->
            </div>

            <!-- Email Form -->
            <div class="email-form">
                <h3>üìß Comparte tus resultados conmigo</h3>
                <p style="color: var(--text-light); margin-bottom: 1.5rem;">
                    Env√≠ame tus resultados y con gusto conversaremos sobre ellos
                </p>

                <div class="success-message" id="successMessage">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path d="M20 6L9 17L4 12" stroke="white" stroke-width="2.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    <span>¬°Resultados enviados exitosamente! Mavi los revisar√° pronto.</span>
                </div>

                <form id="resultsForm" action="https://formspree.io/f/mwpgbdge" method="POST">
                    <div class="form-group">
                        <label for="userName">Tu Nombre *</label>
                        <input type="text" id="userName" name="nombre" required placeholder="Ej. Mar√≠a Gonz√°lez">
                    </div>

                    <div class="form-group">
                        <label for="userEmail">Tu Email *</label>
                        <input type="email" id="userEmail" name="email" required placeholder="tu@email.com">
                    </div>

                    <!-- Hidden fields para enviar los resultados -->
                    <input type="hidden" name="diagnostico_principal" id="hiddenDiagnosis">
                    <input type="hidden" name="porcentaje_ansiedad" id="hiddenAnsiedad">
                    <input type="hidden" name="porcentaje_depresion" id="hiddenDepresion">
                    <input type="hidden" name="porcentaje_estres" id="hiddenEstres">
                    <input type="hidden" name="porcentaje_duelo" id="hiddenDuelo">
                    <input type="hidden" name="porcentaje_vacio" id="hiddenVacio">
                    <input type="hidden" name="respuestas_detalladas" id="hiddenAnswers">

                    <button type="submit" class="btn-submit">
                        üì® Enviar Resultados a Mavi
                    </button>
                </form>
            </div>

            <!-- Bot√≥n de Descarga PDF - Ahora despu√©s del formulario -->
            <div class="download-section">
                <button class="btn-download" onclick="downloadPDF()">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M21 15V19C21 19.5304 20.7893 20.0391 20.4142 20.4142C20.0391 20.7893 19.5304 21 19 21H5C4.46957 21 3.96086 20.7893 3.58579 20.4142C3.21071 20.0391 3 19.5304 3 19V15"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M7 10L12 15L17 10" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        <path d="M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                    </svg>
                    Descargar Resultados en PDF
                </button>
            </div>

            <!-- CTA Section -->
            <div class="cta-section">
                <div
                    style="display: flex; flex-direction: column; align-items: center; gap: 0.5rem; margin-bottom: 1.5rem;">
                    <img src="../assets/logoMavi.png" alt="Mavi Bayona Logo"
                        style="width: 60px; height: auto; display: block; opacity: 0.9;">
                    <img src="../assets/mavibayona-logo.png" alt="Mavi Bayona"
                        style="width: 180px; max-width: 90%; height: auto; display: block; opacity: 0.95;">
                </div>
                <h3>Si sientes que es el momento...</h3>
                <p>Podemos conversar sobre tus resultados y trabajar juntos en tu bienestar</p>
                <a href="../index.html#agendar" class="btn-cta">üìÖ Agendar Mi Cita</a>
            </div>
        </div>
    </div>

    <!-- Lead Magnet Modal -->
    <div class="lead-magnet-overlay" id="leadMagnetModal">
        <div class="lead-magnet-modal">
            <h3>üìß ¬°Un √∫ltimo paso!</h3>
            <p>Para ver tu diagn√≥stico detallado, d√©jame tu correo y te enviar√© los resultados completos</p>
            
            <form class="lead-magnet-form" id="leadMagnetForm">
                <div class="form-group">
                    <label for="leadName">Tu Nombre</label>
                    <input type="text" id="leadName" name="nombre" required placeholder="Ej. Mar√≠a Gonz√°lez">
                </div>
                
                <div class="form-group">
                    <label for="leadEmail">Tu Email</label>
                    <input type="email" id="leadEmail" name="email" required placeholder="tu@email.com">
                </div>
                
                <button type="submit">Ver Mis Resultados</button>
                <a class="skip-button" onclick="skipLeadMagnet()">Ver resultados sin enviar email</a>
            </form>
        </div>
    </div>

    <script>
        // Preguntas del test
        const questions = [
            {
                id: 1,
                text: "¬øCon qu√© frecuencia te sientes nervioso/a o ansioso/a?",
                options: [
                    { text: "Casi nunca", scores: { ansiedad: 0, estres: 0 } },
                    { text: "Ocasionalmente", scores: { ansiedad: 1, estres: 1 } },
                    { text: "Frecuentemente", scores: { ansiedad: 2, estres: 2 } },
                    { text: "Casi siempre", scores: { ansiedad: 3, estres: 3 } }
                ]
            },
            {
                id: 2,
                text: "¬øTe cuesta trabajo sentir inter√©s o placer por hacer cosas?",
                options: [
                    { text: "No, disfruto mis actividades", scores: { depresion: 0, vacio: 0 } },
                    { text: "A veces me cuesta", scores: { depresion: 1, vacio: 1 } },
                    { text: "Frecuentemente no tengo inter√©s", scores: { depresion: 2, vacio: 2 } },
                    { text: "Casi nada me interesa", scores: { depresion: 3, vacio: 3 } }
                ]
            },
            {
                id: 3,
                text: "¬øHas experimentado alguna p√©rdida significativa recientemente?",
                options: [
                    { text: "No", scores: { duelo: 0 } },
                    { text: "Hace m√°s de un a√±o", scores: { duelo: 1 } },
                    { text: "Hace menos de un a√±o", scores: { duelo: 2, ansiedad: 1 } },
                    { text: "Recientemente (menos de 6 meses)", scores: { duelo: 3, ansiedad: 2 } }
                ]
            },
            {
                id: 4,
                text: "¬øC√≥mo describir√≠as tu nivel de estr√©s actualmente?",
                options: [
                    { text: "Bajo, puedo manejarlo", scores: { estres: 0 } },
                    { text: "Moderado, a veces me abruma", scores: { estres: 1, ansiedad: 1 } },
                    { text: "Alto, me cuesta concentrarme", scores: { estres: 2, ansiedad: 2 } },
                    { text: "Muy alto, afecta mi vida diaria", scores: { estres: 3, ansiedad: 3, depresion: 1 } }
                ]
            },
            {
                id: 5,
                text: "¬øTe sientes triste, deprimido/a o sin esperanza?",
                options: [
                    { text: "Casi nunca", scores: { depresion: 0 } },
                    { text: "Algunos d√≠as", scores: { depresion: 1, vacio: 1 } },
                    { text: "M√°s de la mitad del tiempo", scores: { depresion: 2, vacio: 2 } },
                    { text: "Casi todos los d√≠as", scores: { depresion: 3, vacio: 3 } }
                ]
            },
            {
                id: 6,
                text: "¬øTienes problemas para dormir (insomnio o dormir demasiado)?",
                options: [
                    { text: "Duermo bien", scores: { estres: 0 } },
                    { text: "Ocasionalmente tengo problemas", scores: { estres: 1, ansiedad: 1 } },
                    { text: "Frecuentemente", scores: { estres: 2, ansiedad: 2, depresion: 1 } },
                    { text: "Casi todas las noches", scores: { estres: 3, ansiedad: 3, depresion: 2 } }
                ]
            },
            {
                id: 7,
                text: "¬øSientes que tu vida tiene un prop√≥sito o significado claro?",
                options: [
                    { text: "S√≠, tengo claridad en mi prop√≥sito", scores: { vacio: 0 } },
                    { text: "A veces lo cuestiono", scores: { vacio: 1 } },
                    { text: "Frecuentemente me siento perdido/a", scores: { vacio: 2, depresion: 1 } },
                    { text: "No encuentro sentido a mi vida", scores: { vacio: 3, depresion: 2 } }
                ]
            },
            {
                id: 8,
                text: "¬øExperimentas s√≠ntomas f√≠sicos como dolores de cabeza, tensi√≥n muscular o problemas digestivos?",
                options: [
                    { text: "Raramente", scores: { estres: 0 } },
                    { text: "De vez en cuando", scores: { estres: 1, ansiedad: 1 } },
                    { text: "Con frecuencia", scores: { estres: 2, ansiedad: 2 } },
                    { text: "Constantemente", scores: { estres: 3, ansiedad: 3 } }
                ]
            },
            {
                id: 9,
                text: "¬øTe cuesta concentrarte en tus tareas diarias?",
                options: [
                    { text: "No, me concentro bien", scores: { ansiedad: 0 } },
                    { text: "A veces me distraigo", scores: { ansiedad: 1, estres: 1 } },
                    { text: "Frecuentemente", scores: { ansiedad: 2, estres: 2, depresion: 1 } },
                    { text: "Casi nunca puedo concentrarme", scores: { ansiedad: 3, estres: 3, depresion: 2 } }
                ]
            },
            {
                id: 10,
                text: "¬øHas pensado que estar√≠as mejor muerto/a o has tenido pensamientos de hacerte da√±o?",
                options: [
                    { text: "Nunca", scores: { depresion: 0 } },
                    { text: "Raramente", scores: { depresion: 2, vacio: 2 } },
                    { text: "Algunas veces", scores: { depresion: 3, vacio: 3, ansiedad: 2 } },
                    { text: "Frecuentemente", scores: { depresion: 4, vacio: 4, ansiedad: 3 } }
                ]
            },
            {
                id: 11,
                text: "¬øC√≥mo es tu relaci√≥n con los dem√°s actualmente?",
                options: [
                    { text: "Buena, me siento conectado/a", scores: { depresion: 0, vacio: 0 } },
                    { text: "Normal, pero a veces me siento solo/a", scores: { depresion: 1, vacio: 1 } },
                    { text: "Me he alejado de las personas", scores: { depresion: 2, vacio: 2, duelo: 1 } },
                    { text: "Me siento completamente aislado/a", scores: { depresion: 3, vacio: 3, duelo: 2 } }
                ]
            },
            {
                id: 12,
                text: "¬øTe sientes abrumado/a por tus responsabilidades?",
                options: [
                    { text: "No, las manejo bien", scores: { estres: 0 } },
                    { text: "A veces", scores: { estres: 1, ansiedad: 1 } },
                    { text: "Frecuentemente", scores: { estres: 2, ansiedad: 2 } },
                    { text: "Constantemente, no puedo m√°s", scores: { estres: 3, ansiedad: 3, depresion: 1 } }
                ]
            },
            {
                id: 13,
                text: "¬øHas experimentado cambios significativos en tu apetito o peso?",
                options: [
                    { text: "No, todo normal", scores: { depresion: 0 } },
                    { text: "Cambios menores", scores: { depresion: 1, estres: 1 } },
                    { text: "Cambios notables", scores: { depresion: 2, estres: 2 } },
                    { text: "Cambios dr√°sticos", scores: { depresion: 3, estres: 2, ansiedad: 1 } }
                ]
            },
            {
                id: 14,
                text: "¬øTe sientes culpable o crees que eres un fracaso?",
                options: [
                    { text: "No, tengo buena autoestima", scores: { depresion: 0 } },
                    { text: "A veces me critico", scores: { depresion: 1, vacio: 1 } },
                    { text: "Frecuentemente me siento culpable", scores: { depresion: 2, vacio: 2 } },
                    { text: "Constantemente, creo que no valgo nada", scores: { depresion: 3, vacio: 3 } }
                ]
            },
            {
                id: 15,
                text: "¬øC√≥mo te ves a ti mismo/a en el futuro?",
                options: [
                    { text: "Con esperanza y optimismo", scores: { vacio: 0, depresion: 0 } },
                    { text: "Con algunas dudas pero positivo/a", scores: { vacio: 1 } },
                    { text: "Con mucha incertidumbre", scores: { vacio: 2, depresion: 1, ansiedad: 1 } },
                    { text: "Sin esperanza, todo es oscuro", scores: { vacio: 3, depresion: 3, ansiedad: 2 } }
                ]
            }
        ];

        // Estado del test
        let currentQuestionIndex = 0;
        let answers = [];
        let scores = {
            ansiedad: 0,
            depresion: 0,
            estres: 0,
            duelo: 0,
            vacio: 0
        };
        let resultsChart = null;
        let calculatedPercentages = {};

        // Inicializar el test
        function initTest() {
            document.getElementById('totalQuestions').textContent = questions.length;
            renderQuestion();
            setupLeadMagnetForm();
        }

        // Configurar formulario Lead Magnet
        function setupLeadMagnetForm() {
            const leadForm = document.getElementById('leadMagnetForm');
            leadForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('leadName').value;
                const email = document.getElementById('leadEmail').value;
                
                // Guardar datos para el formulario de email posterior
                if (document.getElementById('userName')) {
                    document.getElementById('userName').value = name;
                }
                if (document.getElementById('userEmail')) {
                    document.getElementById('userEmail').value = email;
                }
                
                // Enviar datos a Formspree en background (sin bloquear UI)
                const formData = new FormData();
                formData.append('nombre', name);
                formData.append('email', email);
                formData.append('diagnostico_principal', 'Test completado - Lead Magnet');
                formData.append('fuente', 'Lead Magnet Test');
                
                // Enviar sin bloquear (fire and forget)
                fetch('https://formspree.io/f/mwpgbdge', {
                    method: 'POST',
                    body: formData,
                    headers: {
                        'Accept': 'application/json'
                    }
                }).catch(function(error) {
                    console.log('Info: Lead capturado localmente', error);
                });
                
                // Cerrar modal y mostrar resultados INMEDIATAMENTE
                closeLeadMagnet();
                showResults();
            });
        }

        // Mostrar modal Lead Magnet
        function showLeadMagnet() {
            const modal = document.getElementById('leadMagnetModal');
            modal.classList.add('show');
        }

        // Cerrar modal Lead Magnet
        function closeLeadMagnet() {
            const modal = document.getElementById('leadMagnetModal');
            modal.classList.remove('show');
        }

        // Saltar Lead Magnet
        function skipLeadMagnet() {
            closeLeadMagnet();
            showResults();
        }

        // Renderizar pregunta actual
        function renderQuestion() {
            const container = document.getElementById('questionsContainer');
            const question = questions[currentQuestionIndex];

            const questionHTML = `
                <div class="question-container active" id="question${question.id}">
                    <div class="question-number">Pregunta ${currentQuestionIndex + 1} de ${questions.length}</div>
                    <div class="question-text">${question.text}</div>
                    <div class="options" id="options${question.id}">
                        ${question.options.map((option, index) => `
                            <div class="option" onclick="selectOption(${question.id}, ${index})">
                                <div class="option-radio"></div>
                                <div class="option-text">${option.text}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="navigation">
                        ${currentQuestionIndex > 0 ? `
                            <button class="btn btn-secondary" onclick="previousQuestion()">
                                ‚Üê Anterior
                            </button>
                        ` : '<div></div>'}
                        <button class="btn btn-primary" id="nextBtn" onclick="nextQuestion()" disabled>
                            ${currentQuestionIndex === questions.length - 1 ? 'Ver Resultados' : 'Siguiente ‚Üí'}
                        </button>
                    </div>
                </div>
            `;

            container.innerHTML = questionHTML;
            updateProgress();
        }

        // Seleccionar opci√≥n
        function selectOption(questionId, optionIndex) {
            const question = questions[currentQuestionIndex];
            const options = document.querySelectorAll(`#options${questionId} .option`);

            options.forEach(opt => opt.classList.remove('selected'));
            options[optionIndex].classList.add('selected');

            answers[currentQuestionIndex] = {
                questionId: questionId,
                questionText: question.text,
                optionIndex: optionIndex,
                optionText: question.options[optionIndex].text,
                scores: question.options[optionIndex].scores
            };

            document.getElementById('nextBtn').disabled = false;
        }

        // Siguiente pregunta
        function nextQuestion() {
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                renderQuestion();
            } else {
                calculateResults();
                // Mostrar modal Lead Magnet antes de resultados
                showLeadMagnet();
            }
        }

        // Pregunta anterior
        function previousQuestion() {
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                renderQuestion();

                // Restaurar selecci√≥n anterior si existe
                if (answers[currentQuestionIndex]) {
                    const questionId = questions[currentQuestionIndex].id;
                    const optionIndex = answers[currentQuestionIndex].optionIndex;
                    const options = document.querySelectorAll(`#options${questionId} .option`);
                    options[optionIndex].classList.add('selected');
                    document.getElementById('nextBtn').disabled = false;
                }
            }
        }

        // Actualizar barra de progreso
        function updateProgress() {
            const progress = ((currentQuestionIndex + 1) / questions.length) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
            document.getElementById('currentQuestion').textContent = currentQuestionIndex + 1;
        }

        // Calcular resultados
        function calculateResults() {
            scores = {
                ansiedad: 0,
                depresion: 0,
                estres: 0,
                duelo: 0,
                vacio: 0
            };

            answers.forEach(answer => {
                Object.keys(answer.scores).forEach(key => {
                    scores[key] += answer.scores[key];
                });
            });
        }

        // Mostrar resultados
        function showResults() {
            document.getElementById('questionsContainer').style.display = 'none';
            document.querySelector('.progress-bar').style.display = 'none';
            document.querySelector('.progress-text').style.display = 'none';

            const resultsContainer = document.getElementById('resultsContainer');
            resultsContainer.classList.add('active');

            // Calcular m√°ximo score posible por categor√≠a
            const maxScores = {
                ansiedad: 45,
                depresion: 48,
                estres: 42,
                duelo: 12,
                vacio: 45
            };

            // Calcular porcentajes
            const percentages = {};
            Object.keys(scores).forEach(key => {
                percentages[key] = Math.round((scores[key] / maxScores[key]) * 100);
            });

            calculatedPercentages = percentages;

            // Determinar diagn√≥stico principal
            const maxCategory = Object.keys(percentages).reduce((a, b) =>
                percentages[a] > percentages[b] ? a : b
            );

            // Renderizar diagn√≥stico principal
            renderMainDiagnosis(maxCategory, percentages[maxCategory]);

            // Renderizar gr√°fico circular
            renderChart(percentages);

            // Renderizar scores
            renderScores(percentages);

            // Renderizar recomendaciones
            renderRecommendations(maxCategory, percentages);

            // Llenar campos ocultos para el formulario
            fillHiddenFields(maxCategory, percentages);
        }

        // Renderizar gr√°fico circular
        function renderChart(percentages) {
            const labels = {
                ansiedad: "Ansiedad",
                depresion: "Depresi√≥n",
                estres: "Estr√©s",
                duelo: "Duelo",
                vacio: "Vac√≠o Existencial"
            };

            const colors = {
                ansiedad: '#FF6B6B',
                depresion: '#667EEA',
                estres: '#F6AD55',
                duelo: '#4299E1',
                vacio: '#9F7AEA'
            };

            const ctx = document.getElementById('resultsChart').getContext('2d');

            // Destruir gr√°fico anterior si existe
            if (resultsChart) {
                resultsChart.destroy();
            }

            resultsChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(percentages).map(key => labels[key]),
                    datasets: [{
                        data: Object.values(percentages),
                        backgroundColor: Object.keys(percentages).map(key => colors[key]),
                        borderWidth: 3,
                        borderColor: '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            padding: 12,
                            titleFont: {
                                size: 14,
                                weight: 'bold'
                            },
                            bodyFont: {
                                size: 13
                            },
                            callbacks: {
                                label: function (context) {
                                    return context.label + ': ' + context.parsed + '%';
                                }
                            }
                        }
                    },
                    cutout: '60%'
                }
            });

            // Renderizar leyenda personalizada
            renderChartLegend(percentages, labels, colors);
        }

        // Renderizar leyenda del gr√°fico
        function renderChartLegend(percentages, labels, colors) {
            const legendDiv = document.getElementById('chartLegend');

            legendDiv.innerHTML = Object.keys(percentages).map(key => `
                <div class="legend-item">
                    <div class="legend-label">
                        <div class="legend-color" style="background: ${colors[key]}"></div>
                        ${labels[key]}
                    </div>
                    <div class="legend-value">${percentages[key]}%</div>
                </div>
            `).join('');
        }

        // Renderizar diagn√≥stico principal
        function renderMainDiagnosis(category, percentage) {
            const diagnoses = {
                ansiedad: {
                    title: "Ansiedad Predominante",
                    description: "La ansiedad parece estar presente de manera significativa en tu vida. Esto puede manifestarse como preocupaci√≥n constante, tensi√≥n f√≠sica o dificultad para relajarte. Podemos trabajar juntos en esto."
                },
                depresion: {
                    title: "S√≠ntomas Depresivos",
                    description: "Tus respuestas sugieren que podr√≠as estar experimentando s√≠ntomas depresivos. Esto puede incluir tristeza persistente, falta de energ√≠a o p√©rdida de inter√©s en actividades. Es importante que sepas que no est√°s solo/a."
                },
                estres: {
                    title: "Estr√©s Elevado",
                    description: "El estr√©s parece estar presente de forma importante en tu d√≠a a d√≠a. Esto puede afectar tu capacidad para concentrarte, dormir o manejar tus responsabilidades. Podemos explorar formas de manejarlo."
                },
                duelo: {
                    title: "Proceso de Duelo",
                    description: "Est√°s atravesando un proceso de duelo que merece atenci√≥n. La p√©rdida que has experimentado est√° impactando tu bienestar emocional. El duelo es un camino que se transita mejor acompa√±ado."
                },
                vacio: {
                    title: "Vac√≠o Existencial",
                    description: "Tus respuestas sugieren que podr√≠as estar experimentando una b√∫squeda de sentido o prop√≥sito. Esto puede manifestarse como sensaci√≥n de desconexi√≥n o cuestionamiento sobre tu direcci√≥n en la vida. Podemos explorar esto juntos."
                }
            };

            const diagnosis = diagnoses[category];
            const mainDiagnosisDiv = document.getElementById('mainDiagnosis');

            mainDiagnosisDiv.innerHTML = `
                <div class="diagnosis-title">${diagnosis.title}</div>
                <div class="diagnosis-description">${diagnosis.description}</div>
                <div style="margin-top: 1.5rem; font-size: 1.1rem;">
                    <strong>Nivel de afectaci√≥n: ${percentage}%</strong>
                </div>
            `;
        }

        // Renderizar scores
        function renderScores(percentages) {
            const labels = {
                ansiedad: "Ansiedad",
                depresion: "Depresi√≥n",
                estres: "Estr√©s",
                duelo: "Duelo",
                vacio: "Vac√≠o Existencial"
            };

            const scoresGrid = document.getElementById('scoresGrid');
            scoresGrid.innerHTML = Object.keys(percentages).map(key => `
                <div class="score-card">
                    <div class="score-label">${labels[key]}</div>
                    <div class="score-bar">
                        <div class="score-bar-fill ${key}" style="width: ${percentages[key]}%"></div>
                    </div>
                    <div class="score-percentage">${percentages[key]}%</div>
                </div>
            `).join('');
        }

        // Renderizar recomendaciones
        function renderRecommendations(mainCategory, percentages) {
            const recommendationsDiv = document.getElementById('recommendations');

            let recommendations = [
                "Si sientes que necesitas apoyo, considera conversar sobre estos resultados en una consulta",
                "Lo que est√°s sintiendo es v√°lido - buscar ayuda es un signo de fortaleza y autocuidado"
            ];

            // Recomendaciones espec√≠ficas seg√∫n categor√≠a principal
            if (mainCategory === 'ansiedad') {
                recommendations.push(
                    "Practica t√©cnicas de respiraci√≥n profunda y mindfulness",
                    "Establece una rutina de ejercicio regular",
                    "Limita el consumo de cafe√≠na y estimulantes"
                );
            } else if (mainCategory === 'depresion') {
                recommendations.push(
                    "Mant√©n una rutina diaria estructurada",
                    "Busca apoyo en tus seres queridos - no atravieses esto solo/a",
                    "Prioriza actividades de autocuidado y descanso adecuado"
                );

                if (percentages.depresion >= 60) {
                    recommendations.push("‚ö†Ô∏è IMPORTANTE: Si tienes pensamientos de hacerte da√±o, busca ayuda inmediata llamando a una l√≠nea de crisis");
                }
            } else if (mainCategory === 'estres') {
                recommendations.push(
                    "Aprende t√©cnicas de gesti√≥n del tiempo y priorizaci√≥n",
                    "Establece l√≠mites saludables en tu vida personal y profesional",
                    "Dedica tiempo diario para actividades que te relajen"
                );
            } else if (mainCategory === 'duelo') {
                recommendations.push(
                    "Perm√≠tete sentir y expresar tus emociones sin juzgarlas",
                    "Date tiempo para procesar tu p√©rdida a tu propio ritmo",
                    "Considera unirte a un grupo de apoyo de personas en situaciones similares"
                );
            } else if (mainCategory === 'vacio') {
                recommendations.push(
                    "Reflexiona sobre tus valores y lo que realmente importa para ti",
                    "Explora actividades que te den sentido de prop√≥sito",
                    "Considera actividades de voluntariado o ayuda a otros"
                );
            }

            recommendationsDiv.innerHTML = `
                <h3>Recomendaciones Personalizadas</h3>
                <ul>
                    ${recommendations.map(rec => `<li>${rec}</li>`).join('')}
                </ul>
            `;
        }

        // Llenar campos ocultos del formulario
        function fillHiddenFields(mainCategory, percentages) {
            const diagnoses = {
                ansiedad: "Ansiedad Predominante",
                depresion: "S√≠ntomas Depresivos",
                estres: "Estr√©s Elevado",
                duelo: "Proceso de Duelo",
                vacio: "Vac√≠o Existencial"
            };

            document.getElementById('hiddenDiagnosis').value = diagnoses[mainCategory];
            document.getElementById('hiddenAnsiedad').value = percentages.ansiedad + '%';
            document.getElementById('hiddenDepresion').value = percentages.depresion + '%';
            document.getElementById('hiddenEstres').value = percentages.estres + '%';
            document.getElementById('hiddenDuelo').value = percentages.duelo + '%';
            document.getElementById('hiddenVacio').value = percentages.vacio + '%';

            // Crear resumen de respuestas
            const answersText = answers.map((a, i) =>
                `P${i + 1}: ${a.questionText}\nR: ${a.optionText}`
            ).join('\n\n');
            document.getElementById('hiddenAnswers').value = answersText;
        }

        // Manejar env√≠o del formulario
        document.getElementById('resultsForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'Accept': 'application/json'
                }
            })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('successMessage').classList.add('show');
                        // NO resetear el formulario para mantener los datos
                        setTimeout(() => {
                            document.getElementById('successMessage').classList.remove('show');
                        }, 5000);
                    } else {
                        alert('Hubo un error al enviar los resultados. Por favor intenta de nuevo.');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Hubo un error al enviar los resultados. Por favor intenta de nuevo.');
                });
        });

        // Inicializar test al cargar la p√°gina
        window.addEventListener('DOMContentLoaded', initTest);

        // Funci√≥n para descargar resultados en PDF
        async function downloadPDF() {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF('p', 'mm', 'a4');

            // Colores
            const primaryCyan = [27, 154, 170];
            const primaryGold = [212, 175, 55];
            const textDark = [51, 51, 51];
            const textLight = [102, 102, 102];

            // Configuraci√≥n inicial
            let yPosition = 20;
            const pageWidth = pdf.internal.pageSize.getWidth();
            const pageHeight = pdf.internal.pageSize.getHeight();
            const margin = 20;
            const contentWidth = pageWidth - (margin * 2);
            const bottomMargin = 30; // Margen inferior para el footer

            // Funci√≥n para verificar si necesitamos nueva p√°gina
            function checkNewPage(requiredSpace) {
                if (yPosition + requiredSpace > pageHeight - bottomMargin) {
                    pdf.addPage();
                    yPosition = 20;
                    return true;
                }
                return false;
            }

            // Header con logo (texto)
            pdf.setFillColor(...primaryCyan);
            pdf.rect(0, 0, pageWidth, 35, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(22);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Test de Diagn√≥stico Emocional', pageWidth / 2, 15, { align: 'center' });
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'normal');
            pdf.text('Resultados Personalizados - Mavi Bayona', pageWidth / 2, 24, { align: 'center' });

            yPosition = 45;

            // Informaci√≥n del usuario
            const userName = document.getElementById('userName').value || 'Usuario';
            const userEmail = document.getElementById('userEmail').value || 'Sin email';
            const currentDate = new Date().toLocaleDateString('es-MX', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });

            pdf.setTextColor(...textDark);
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Nombre: ${userName}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`Email: ${userEmail}`, margin, yPosition);
            yPosition += 6;
            pdf.text(`Fecha: ${currentDate}`, margin, yPosition);
            yPosition += 12;

            // Diagn√≥stico Principal
            const maxCategory = Object.keys(calculatedPercentages).reduce((a, b) =>
                calculatedPercentages[a] > calculatedPercentages[b] ? a : b
            );

            const diagnoses = {
                ansiedad: "Ansiedad Predominante",
                depresion: "S√≠ntomas Depresivos",
                estres: "Estr√©s Elevado",
                duelo: "Proceso de Duelo",
                vacio: "Vac√≠o Existencial"
            };

            const descriptions = {
                ansiedad: "Est√°s experimentando preocupaci√≥n constante y nerviosismo que afecta tu d√≠a a d√≠a. Es comprensible que te sientas as√≠, y quiero que sepas que no est√°s solo/a en esto.",
                depresion: "La tristeza persistente y la p√©rdida de inter√©s en cosas que antes disfrutabas son se√±ales importantes. Reconocer esto es un paso valiente hacia tu bienestar.",
                estres: "Est√°s llevando una carga emocional considerable que dificulta manejar tus responsabilidades. Es momento de darte permiso de pedir ayuda y cuidar de ti.",
                duelo: "Est√°s atravesando un proceso de adaptaci√≥n ante una p√©rdida significativa. El duelo es un camino que no tiene que recorrerse en soledad.",
                vacio: "Sientes falta de prop√≥sito o sentido en diferentes √°reas de tu vida. Esta sensaci√≥n es m√°s com√∫n de lo que crees, y juntos podemos explorar nuevos significados."
            };

            checkNewPage(35);

            // Recuadro del diagn√≥stico principal
            pdf.setFillColor(...primaryCyan);
            pdf.roundedRect(margin, yPosition, contentWidth, 30, 3, 3, 'F');
            pdf.setTextColor(255, 255, 255);
            pdf.setFontSize(14);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Diagn√≥stico Principal', pageWidth / 2, yPosition + 10, { align: 'center' });
            pdf.setFontSize(16);
            pdf.text(diagnoses[maxCategory], pageWidth / 2, yPosition + 18, { align: 'center' });
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');
            pdf.text(`Nivel de afectaci√≥n: ${calculatedPercentages[maxCategory]}%`, pageWidth / 2, yPosition + 26, { align: 'center' });

            yPosition += 38;

            // Descripci√≥n del diagn√≥stico
            checkNewPage(20);
            pdf.setTextColor(...textDark);
            pdf.setFontSize(9);
            const descLines = pdf.splitTextToSize(descriptions[maxCategory], contentWidth - 10);
            pdf.text(descLines, margin + 5, yPosition);
            yPosition += descLines.length * 4 + 8;

            // Resultados detallados
            checkNewPage(15);
            pdf.setTextColor(...primaryCyan);
            pdf.setFontSize(13);
            pdf.setFont('helvetica', 'bold');
            pdf.text('Resultados Detallados', margin, yPosition);
            yPosition += 8;

            const labels = {
                ansiedad: "Ansiedad",
                depresion: "Depresi√≥n",
                estres: "Estr√©s",
                duelo: "Duelo",
                vacio: "Vac√≠o Existencial"
            };

            const colors = {
                ansiedad: [255, 107, 107],
                depresion: [102, 126, 234],
                estres: [246, 173, 85],
                duelo: [66, 153, 225],
                vacio: [159, 122, 234]
            };

            // Dibujar barras de progreso para cada categor√≠a
            pdf.setFontSize(10);
            pdf.setFont('helvetica', 'normal');

            Object.keys(calculatedPercentages).forEach(key => {
                checkNewPage(18);

                const percentage = calculatedPercentages[key];
                const barWidth = contentWidth - 35;
                const fillWidth = (barWidth * percentage) / 100;

                // Etiqueta
                pdf.setTextColor(...textDark);
                pdf.text(labels[key], margin, yPosition);

                // Porcentaje
                pdf.setFont('helvetica', 'bold');
                pdf.text(`${percentage}%`, pageWidth - margin, yPosition, { align: 'right' });
                pdf.setFont('helvetica', 'normal');

                yPosition += 5;

                // Barra de fondo
                pdf.setFillColor(224, 224, 224);
                pdf.roundedRect(margin, yPosition, barWidth, 5, 2, 2, 'F');

                // Barra de progreso
                if (percentage > 0) {
                    pdf.setFillColor(...colors[key]);
                    pdf.roundedRect(margin, yPosition, fillWidth, 5, 2, 2, 'F');
                }

                yPosition += 10;
            });

            yPosition += 5;

            // Recomendaciones
            checkNewPage(60); // Asegurar espacio suficiente

            pdf.setFontSize(13);
            pdf.setFont('helvetica', 'bold');
            pdf.setTextColor(...primaryCyan);
            pdf.text('Recomendaciones para Ti', margin, yPosition);
            yPosition += 10;

            // Mensaje emp√°tico inicial
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'italic');
            pdf.setTextColor(...textLight);
            const empathyText = 'Recuerda que buscar ayuda es un acto de valent√≠a y amor propio. Estos son algunos pasos que puedes dar:';
            const empathyLines = pdf.splitTextToSize(empathyText, contentWidth - 10);
            pdf.text(empathyLines, margin + 5, yPosition);
            yPosition += empathyLines.length * 4 + 6;

            // Calcular altura necesaria para el fondo
            const recomStartY = yPosition;

            const recommendations = [
                'Considera agendar una consulta profesional. Juntos podemos trabajar en un plan personalizado para tu bienestar.',
                'Lo que est√°s sintiendo es v√°lido e importante. No minimices tus emociones - reconocerlas es el primer paso.',
                'Cuida tu cuerpo con cari√±o: establece horarios regulares de sue√±o, alimentaci√≥n balanceada y peque√±os momentos de descanso.',
                'Dedica unos minutos cada d√≠a a t√©cnicas de respiraci√≥n, meditaci√≥n o mindfulness. Tu mente merece estos espacios de calma.',
                'Mantente conectado/a con las personas que te importan. Compartir lo que sientes con alguien de confianza puede aliviar la carga.'
            ];

            // Calcular altura total necesaria
            let totalHeight = 5;
            const tempLines = [];
            recommendations.forEach(rec => {
                const lines = pdf.splitTextToSize(rec, contentWidth - 15);
                tempLines.push(lines);
                totalHeight += lines.length * 4 + 3;
            });
            totalHeight += 5;

            // Dibujar PRIMERO el fondo
            pdf.setFillColor(255, 251, 245); // Tono c√°lido y suave
            pdf.roundedRect(margin - 2, recomStartY - 3, contentWidth + 4, totalHeight, 2, 2, 'F');

            // LUEGO dibujar las recomendaciones
            pdf.setTextColor(...textDark);
            pdf.setFontSize(9);

            tempLines.forEach(lines => {
                const bullet = '‚Ä¢';
                pdf.setFont('helvetica', 'bold');
                pdf.setTextColor(...primaryGold);
                pdf.text(bullet, margin + 3, yPosition);

                pdf.setFont('helvetica', 'normal');
                pdf.setTextColor(...textDark);
                pdf.text(lines, margin + 8, yPosition);
                yPosition += lines.length * 4 + 3;
            });

            yPosition += 5;

            // Nota importante si hay niveles altos
            if (calculatedPercentages.depresion >= 60 || calculatedPercentages.ansiedad >= 70) {
                checkNewPage(30);

                pdf.setFillColor(255, 245, 240); // Tono c√°lido y suave
                pdf.roundedRect(margin, yPosition, contentWidth, 24, 2, 2, 'F');

                pdf.setTextColor(200, 80, 60); // Rojo m√°s suave
                pdf.setFontSize(10);
                pdf.setFont('helvetica', 'bold');
                pdf.text('üíõ Un Mensaje Importante para Ti', margin + 5, yPosition + 7);

                pdf.setTextColor(...textDark);
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'normal');
                const warningText = 'Tus resultados muestran que est√°s pasando por un momento dif√≠cil. Me gustar√≠a acompa√±arte en este proceso. Considera agendar una consulta pronto - no tienes que enfrentar esto solo/a. Estoy aqu√≠ para apoyarte.';
                const warningLines = pdf.splitTextToSize(warningText, contentWidth - 15);
                pdf.text(warningLines, margin + 5, yPosition + 13);

                yPosition += 30;
            }

            // Call to Action
            checkNewPage(28);

            pdf.setFillColor(245, 250, 255); // Azul muy suave
            pdf.roundedRect(margin, yPosition, contentWidth, 26, 3, 3, 'F');

            pdf.setTextColor(...primaryCyan);
            pdf.setFontSize(11);
            pdf.setFont('helvetica', 'bold');
            pdf.text('¬øListo/a para dar el siguiente paso?', pageWidth / 2, yPosition + 9, { align: 'center' });

            pdf.setTextColor(...textDark);
            pdf.setFontSize(9);
            pdf.setFont('helvetica', 'normal');
            const ctaText = 'Agenda tu primera consulta y trabajemos juntos en tu bienestar emocional. Estoy aqu√≠ para acompa√±arte en este camino.';
            const ctaLines = pdf.splitTextToSize(ctaText, contentWidth - 20);
            pdf.text(ctaLines, pageWidth / 2, yPosition + 16, { align: 'center' });

            // Footer en todas las p√°ginas
            const totalPages = pdf.internal.pages.length - 1;
            for (let i = 1; i <= totalPages; i++) {
                pdf.setPage(i);
                const finalY = pageHeight - 20;

                pdf.setFillColor(...primaryGold);
                pdf.rect(0, finalY, pageWidth, 20, 'F');

                pdf.setTextColor(255, 255, 255);
                pdf.setFontSize(9);
                pdf.setFont('helvetica', 'bold');
                pdf.text('Mavi Bayona - Psicoterapeuta | Tanat√≥loga | Logoterapeuta', pageWidth / 2, finalY + 7, { align: 'center' });

                pdf.setFont('helvetica', 'normal');
                pdf.setFontSize(8);
                pdf.text('Este test no reemplaza una consulta profesional - Es una herramienta de orientaci√≥n', pageWidth / 2, finalY + 13, { align: 'center' });

                // N√∫mero de p√°gina
                pdf.setFontSize(8);
                pdf.text(`P√°gina ${i} de ${totalPages}`, pageWidth - margin, finalY + 10, { align: 'right' });
            }

            // Descargar PDF
            const fileName = `Resultados_Test_${userName.replace(/\s+/g, '_')}_${new Date().toLocaleDateString('es-MX').replace(/\//g, '-')}.pdf`;
            pdf.save(fileName);
        }

        // Inicializar cuando cargue el DOM
        window.addEventListener('DOMContentLoaded', initTest);
    </script>
</body>

</html>